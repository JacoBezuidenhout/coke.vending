<!DOCTYPE html>
<html>
<head>
	<title>Coke Vending Frontend</title>
	<meta charset="UTF-8">
	<script type="text/javascript" src="peer.min.js"></script>
	<script type="text/javascript" src="home.js"></script>
	<script type="text/javascript" src="home.js"></script>
	<script type="text/javascript" src="jquery.min.js"></script>
	<script type="text/javascript" src="sails.io.js"></script>
	<link rel="stylesheet" href="home.css">

</head>
<body id="page_body" style="padding:0px;margin:0px;">
<div id="vidDiv" width="1920" height="1080">
	<img id="vidDivImg" alt="">

	<img id="smileyOne" alt="">
	<img id="smileyTwo" alt="">

	<p id="teamName"></p>
	<p id="phraseOne"></p>
	<p id="phraseTwo"></p>

	<div id="vidDivContainer">
		<video id="video" width="1920" height="1080" autoplay></video>
	<div>

	<div style="position: absolute; top: 0; left: 0; width:100%; height:100%; z-index:1;">
      <div style="position: absolute;bottom:370px;right:25%; width:400px;height:400px;" id="rightLoad"><div class="circle"></div></div>
      <div style="position: absolute;bottom:300px;right:25%; width:400px;height:400px;" id="rightStatic"><div class="circle1"></div></div>
    </div>
    <div style="position: absolute; top: 0; left: 0; width:100%; height:100%; z-index:1;">
      <div style="position: absolute;bottom:370px;left:25%; width:400px;height:400px;" id="leftLoad"><div class="circle"></div></div>
      <div style="position: absolute;bottom:300px;left:25%; width:400px;height:400px;" id="leftStatic"><div class="circle1"></div></div>
    </div>
</div>
<!--id: 1 => Fun 
id: 2 => Together
id: 3 => Holiday
id: 4 => Summer
id: 5 => Forever
id: 6 => Love -->
<script>
	io.sails.url = 'http://127.0.0.1:8080';
	var productDesc = {"7":"emoji1","8":"emoji2","9":"emoji3","10":"emoji4","11":"emoji5","12":"emoji6","1":"Fun","2":"Together","3":"Holiday","4":"Summer","5":"Forever","6":"Love"};

	var soundFiles = ["Aweh.m4a" , "FacialRecognitionComplete.m4a" , "GetReadyToMimic.m4a" , "ImNotFeelingYouTryOneMoreTime.m4a" , "LetsTryThatOneMoreTime.m4a" , "SoManyFeelingsSoLittleTime.m4a" , "ThankYouForSharingYourFeelings.m4a" , "WellArentYouTwoGoodLooking.m4a" , "WhatBeautifulFaces.m4a" , "YouGuysMadeMeBlush.m4a" , "YouTwoWereAmazing.m4a"];
	
	var soundFilesGetReady = ["GetReadyToMimic.m4a","SoManyFeelingsSoLittleTime.m4a"];
	var soundFilesSuccess = ["Aweh.m4a","FacialRecognitionComplete.m4a"];
	var soundFilesError = ["ImNotFeelingYouTryOneMoreTime.m4a","LetsTryThatOneMoreTime.m4a"];
	var soundFilesPicture = ["ThankYouForSharingYourFeelings.m4a","WhatBeautifulFaces.m4a","YouGuysMadeMeBlush.m4a","YouTwoWereAmazing.m4a","WellArentYouTwoGoodLooking.m4a"];


	var next = true;

	var ngui = require('nw.gui');
	var nwin = ngui.Window.get();
	nwin.enterFullscreen();

	var currentId = 'noId'; 
	// setTimeout(function(){
	// 	videoScreen();
	// },2000);

	// setTimeout(function(){
	// 	takeImage();
	// },4000);

 	/*changeBackgroundImg("videobackground");
	changeSmileyOne("emoji1");
	changeSmileyTwo("emoji2");
	changePhraseOne("Summer");
	changePhraseTwo("Fun");*/

	  function start(){
	    $("#leftStatic").show();
	    $("#rightStatic").show();
	    videoScreen();
	    playSound(soundFilesGetReady);
	  }

	  function map(id) {
	  	return productDesc[id];
	  }

	  function takeSnapshot() {
		    var gui = require('nw.gui');
		    var win = gui.Window.get();

		    win.capturePage(function(buffer)
		    {
		        require('fs').writeFile('../../ownCloud/Photos/' + currentId + '.png', buffer, function (err) {
		            if (err) throw err;
		            console.log('It\'s saved!');
		        });

		    }, { format : 'png', datatype : 'buffer'} );
		}
			
	  function loadNext(){
	  	io.socket.get('/order?done=false&limit=1', function serverResponded (body, JWR) {
	  		console.log(body);
	  		if (body.length)
	  		{
	  			currentId = body[0].id;
  				startScreen(body[0].teamName, map(body[0].smileyOne.id), map(body[0].smileyTwo.id), map(body[0].stickerOne.id), map(body[0].stickerTwo.id));
	  		}
  			else
  			{
  				next = false;
  			}
	  	});
	  }

	  function done(){
	    $("#leftStatic").fadeOut(500);
	    $("#rightStatic").fadeOut(500);
	    $("#leftLoad").fadeOut(500);
	    $("#rightLoad").fadeOut(500);
	    playSound(soundFilesSuccess);
	    changeBackgroundImg("awesome");
	  }

	  function takePicture(){
	  	takeImage(function(){
	  		playSound(soundFilesPicture);
	  		io.socket.get('/order/update/' + currentId + '?done=true', function serverResponded (body, JWR) {
		  		setTimeout(function(){
		  			loadNext();
		  		},4000);
	  		});
	  	});
	  };
	
	  function cancel()
	  {
	  	playSound(soundFilesError);
	  	$("#leftLoad").fadeOut(500);
	    $("#rightLoad").fadeOut(500);
	  }

	  function startL(time){
	    if (time > 0)
	      $("#leftLoad").fadeIn(500);
	    else
	      cancel();
	  }

	  function startR(time){
	    if (time > 0)
	      $("#rightLoad").fadeIn(500);
	    else
	      cancel();
	  }

	  $(document).ready(function(){
	    $("#leftLoad").hide();
	    $("#rightLoad").hide();

	    $("#leftStatic").hide();
	    $("#rightStatic").hide();
	    io.socket.get('/order', function serverResponded (body, JWR) {
			io.socket.on('order', function serverResponded (body, JWR) {
				if (!next)
				{
					loadNext();
				}
			});
	    });
	   });


	var initPeer = function(videoStream)
	{
		console.log("InitStarted");
		var peer = new Peer('sender', {host: '127.0.0.1', port:9000, path: '/', key: 'peerjs'});
		peer.on('open', function(conn) {
			console.log("OPEN");
		});

		peer.on('connection', function(conn) {
			console.log("Another Connected");
			conn.on('data', function(data){
				console.log(data);
				if (data == "hi!")
				{
					loadNext();
					peer.call('rec', videoStream);
				}
				if (data == "start") start();
				if (data == "takeImage") takePicture();
				if (data == "done") done();
				if (data[0] == "L") startL(parseInt(data[1]));
				if (data[0] == "R") startR(parseInt(data[1]));
			});
		});
	}

	var vgaConstraints2 = {
	 "audio": false,
	 "video": {
	  "mandatory": {
	   "maxWidth": 800,
	   "maxHeight": 600
	   // "minFrameRate": 30
	  }
	 }
	}
	var vgaConstraints = {
	 "audio": false,
	 "video": {
	  "mandatory": {
	   "minWidth": 1440,
	   "minHeight": 810
	   // "minFrameRate": 30
	  }
	 }
	}

	navigator.getUserMedia = navigator.getUserMedia || navigator.webkitGetUserMedia || navigator.mozGetUserMedia;
	navigator.getUserMedia(vgaConstraints, function(stream) {
		var video = document.querySelector('video');
		video.src = window.URL.createObjectURL(stream);
	}, function(err) {
	  console.log('Failed to get local stream' ,err);
	});
	navigator.getUserMedia(vgaConstraints2, function(stream) {
		videoStream = stream;
		initPeer(stream);
	}, function(err) {
	  console.log('Failed to get local stream' ,err);
	});

	// Not showing vendor prefixes.
	// navigator.webkitGetUserMedia(vgaConstraints, function(localMediaStream) {
	// 	console.log(video.src);
	// 	video.onloadedmetadata = function(e) {
	// 		//
	// 	};
	// }, errorCallback);


</script>
</body>
</html>
