<!DOCTYPE html>
<html>
<head>
	<title>Coke Vending Frontend</title>
	<meta charset="UTF-8">
	<script type="text/javascript" src="peer.min.js"></script>
	<script type="text/javascript" src="home.js"></script>
	<script type="text/javascript" src="home.js"></script>
	<script type="text/javascript" src="jquery.min.js"></script>
	<script type="text/javascript" src="sails.io.js"></script>
	<link rel="stylesheet" href="home.css">

</head>
<body id="page_body" >
<div id="vidDiv" width="1920" height="1080">
	<img id="vidDivImg" alt="">

	<img id="smileyOne" alt="">
	<img id="smileyTwo" alt="">

	<p id="teamName"></p>
	<p id="phraseOne"></p>
	<p id="phraseTwo"></p>


	<div id="vidDivContainer">
		<video id="video" width="1920" height="1080" autoplay></video>
	<div>

	<div style="position: absolute; top: 0; left: 0; width:100%; height:100%; z-index:1;">
      <div style="position: absolute;bottom:370px;right:25%; width:400px;height:400px;" id="rightLoad"><div class="circle"></div></div>
      <div style="position: absolute;bottom:300px;right:25%; width:400px;height:400px;" id="rightStatic"><div class="circle1"></div></div>
    </div>
    <div style="position: absolute; top: 0; left: 0; width:100%; height:100%; z-index:1;">
      <div style="position: absolute;bottom:370px;left:25%; width:400px;height:400px;" id="leftLoad"><div class="circle"></div></div>
      <div style="position: absolute;bottom:300px;left:25%; width:400px;height:400px;" id="leftStatic"><div class="circle1"></div></div>
    </div>
</div>
 
<script>
	io.sails.url = 'http://192.168.0.2:80';
	var productDesc = {"1":"emoji1","2":"emoji2","3":"emoji3","4":"emoji4","5":"emoji5","6":"emoji6","7":"Love","8":"Summer","9":"Joy","10":"Sun","11":"Beach","12":"Cool"};

	var ngui = require('nw.gui');
	var nwin = ngui.Window.get();
	nwin.enterFullscreen();

	// setTimeout(function(){
	// 	videoScreen();
	// },2000);

	// setTimeout(function(){
	// 	takeImage();
	// },4000);

 	/*changeBackgroundImg("videobackground");
	changeSmileyOne("emoji1");
	changeSmileyTwo("emoji2");
	changePhraseOne("Summer");
	changePhraseTwo("Fun");*/
	
	  function start(){
	    $("#leftStatic").show();
	    $("#rightStatic").show();
	    videoScreen();
	  }

	  function map(id) {
	  	return productDesc[id];
	  }

	  function loadNext(){
	  	io.socket.get('/order?picture=false&limit=1', function serverResponded (body, JWR) {
	  		console.log(body);
  			startScreen(body[0].teamName, map(body[0].smileyOne.id), map(body[0].smileyTwo.id), map(body[0].stickerOne.id), map(body[0].smileyTwo.id));
	  	});
	  }

	  function done(){
	    $("#leftStatic").fadeOut(500);
	    $("#rightStatic").fadeOut(500);
	    $("#leftLoad").fadeOut(500);
	    $("#rightLoad").fadeOut(500);
	  	takeImage(function(){
	  		setTimeout(function(){
	  			loadNext();
	  		},4000);
	  	});
	  }

	  function startL(time){
	    if (time > 0)
	      $("#leftLoad").fadeIn(500);
	    else
	      $("#leftLoad").fadeOut(500);
	  }

	  function startR(time){
	    if (time > 0)
	      $("#rightLoad").fadeIn(500);
	    else
	      $("#rightLoad").fadeOut(500);
	  }
	  
	  $(document).ready(function(){
	    $("#leftLoad").hide();
	    $("#rightLoad").hide();
	    
	    $("#leftStatic").hide();
	    $("#rightStatic").hide();
	   });


	var initPeer = function(videoStream)
	{
		console.log("InitStarted");
		var peer = new Peer('sender', {host: '192.168.0.2', port: 9000, path: '/', key: 'peerjs'});
		peer.on('open', function(conn) {
			console.log("OPEN");
		});	

		peer.on('connection', function(conn) {
			console.log("Another Connected");
			conn.on('data', function(data){
			    // Will print 'hi!'
				console.log(data);
				if (data == "hi!") 
				{
					loadNext();
					peer.call('rec', videoStream);
				}
				if (data == "start") start();
				if (data == "done") done();
				if (data[0] == "L") startL(parseInt(data[1]));
				if (data[0] == "R") startR(parseInt(data[1]));
			});
		});
	}
	var vgaConstraints = {
	 "audio": false,
	 "video": {
	  "mandatory": {
	   "minWidth": 1920,
	   "minHeight": 1080
	   // "minFrameRate": 30
	  }
	 }
	}

	navigator.getUserMedia = navigator.getUserMedia || navigator.webkitGetUserMedia || navigator.mozGetUserMedia;
	navigator.getUserMedia(vgaConstraints, function(stream) {
		var video = document.querySelector('video');
		video.src = window.URL.createObjectURL(stream);
		videoStream = stream;
		initPeer(stream);
	}, function(err) {
	  console.log('Failed to get local stream' ,err);
	});

	// Not showing vendor prefixes.
	// navigator.webkitGetUserMedia(vgaConstraints, function(localMediaStream) {
	// 	console.log(video.src);
	// 	video.onloadedmetadata = function(e) {
	// 		//
	// 	};
	// }, errorCallback);


</script>
</body>
</html>
